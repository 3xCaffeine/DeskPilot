; supervisord.conf - Process manager for our Docker container
; ============================================================
; WHY SUPERVISORD?
; Docker runs ONE process by default. We need THREE:
;   1. Xvfb     - Virtual display (the "monitor")
;   2. x11vnc   - VNC server (so you can view the desktop)
;   3. xfce4    - The actual desktop environment
;
; Supervisord manages all three and restarts them if they crash.

[supervisord]
nodaemon=true                  ; Run in foreground (Docker needs this)
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid

; ─────────────────────────────────────────────────────────────
; PROCESS 1: Xvfb (X Virtual Framebuffer)
; Creates a fake display :99 with 1280x720 resolution
; Think of it as a virtual monitor that exists only in memory
; ─────────────────────────────────────────────────────────────
[program:xvfb]
command=/usr/bin/Xvfb :99 -screen 0 1280x720x24
autorestart=true
priority=100                   ; Start first (others depend on it)
stdout_logfile=/var/log/xvfb.log
stderr_logfile=/var/log/xvfb.err

; ─────────────────────────────────────────────────────────────
; PROCESS 1b: D-Bus (Required for Chrome)
; ─────────────────────────────────────────────────────────────
[program:dbus]
command=/usr/bin/dbus-daemon --session --nofork --nopidfile
environment=DISPLAY=":99"
autorestart=true
priority=150
stdout_logfile=/var/log/dbus.log
stderr_logfile=/var/log/dbus.err

; ─────────────────────────────────────────────────────────────
; PROCESS 2: XFCE4 Desktop
; A lightweight Linux desktop that runs on our virtual display
; ─────────────────────────────────────────────────────────────
[program:xfce]
command=/usr/bin/startxfce4
environment=DISPLAY=":99"      ; Tell XFCE to use our virtual display
autorestart=true
priority=200                   ; Start after Xvfb
stdout_logfile=/var/log/xfce.log
stderr_logfile=/var/log/xfce.err

; ─────────────────────────────────────────────────────────────
; PROCESS 3: x11vnc (VNC Server)
; Lets you connect from your PC to SEE the virtual desktop
; Connect with any VNC viewer to localhost:5900
; ─────────────────────────────────────────────────────────────
[program:x11vnc]
command=/usr/bin/x11vnc -display :99 -forever -nopw -shared -rfbport 5900
autorestart=true
priority=300                   ; Start after desktop is up
stdout_logfile=/var/log/x11vnc.log
stderr_logfile=/var/log/x11vnc.err

; ─────────────────────────────────────────────────────────────
; PROCESS 4: noVNC (Browser-based VNC)
; Access the desktop in your browser at http://localhost:6080
; 
; HOW IT WORKS:
;   websockify: Bridges VNC (port 5900) → WebSocket (port 6080)
;   noVNC: HTML/JS client that connects via WebSocket
;
; FOR FRONTEND INTEGRATION:
;   Embed an iframe pointing to http://localhost:6080/vnc.html
;   Or use noVNC's JavaScript API directly
; ─────────────────────────────────────────────────────────────
[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc/ 6080 localhost:5900
autorestart=true
priority=400                   ; Start after VNC is up
stdout_logfile=/var/log/novnc.log
stderr_logfile=/var/log/novnc.err
